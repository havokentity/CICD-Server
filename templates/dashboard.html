{% extends "base.html" %}

{% block title %}Dashboard - CICD Server{% endblock %}

{% block content %}
<div class="container-fluid py-4" data-build-in-progress="{{ build_in_progress|string|lower }}">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Dashboard</h2>
        <div>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#triggerBuildModal">
                Trigger Build
            </button>
            {% if build_in_progress %}
            <span class="badge bg-info ms-2">Build in progress</span>
            {% endif %}
            {% if queued_builds_count > 0 %}
            <span class="badge bg-secondary ms-2">{{ queued_builds_count }} build{% if queued_builds_count > 1 %}s{% endif %} queued</span>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Recent Builds</h5>
                    {% if total_pages > 1 %}
                    <span class="text-muted">Page {{ current_page }} of {{ total_pages }}</span>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if builds %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Status</th>
                                    <th>Configuration</th>
                                    <th>Branch</th>
                                    <th>Started</th>
                                    <th>Completed</th>
                                    <th>Triggered By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for build in builds %}
                                <tr data-build-id="{{ build.id }}">
                                    <td>{{ build.id }}</td>
                                    <td>
                                        <span class="build-status build-status-{{ build.status }}">
                                            {{ build.status.upper() }}
                                        </span>
                                        {% if build.status == 'queued' and build.queue_position %}
                                        <div class="mt-1">
                                            <small class="text-muted">Queue position: {{ build.queue_position }}</small>
                                        </div>
                                        {% endif %}
                                        {% if build.status == 'running' and build.total_steps > 0 %}
                                        <div class="mt-1">
                                            <div class="progress" style="height: 5px;">
                                                <div class="progress-bar {% if builds_progress[build.id].steps_overdue %}bg-warning{% endif %}" 
                                                     role="progressbar" 
                                                     data-progress="{{ builds_progress[build.id].percent }}"
                                                     aria-valuenow="{{ builds_progress[build.id].percent }}" 
                                                     aria-valuemin="0" 
                                                     aria-valuemax="100"></div>
                                            </div>
                                            <small class="text-muted">{{ builds_progress[build.id].percent }}% (Step {{ build.current_step }}/{{ build.total_steps }})</small>
                                        </div>
                                        {% endif %}
                                    </td>
                                    <td>{{ build.config.name }}</td>
                                    <td>{{ build.branch }}</td>
                                    <td>
                                        {{ build.started_at.strftime('%Y-%m-%d %H:%M:%S') if build.started_at else 'N/A' }}
                                        {% if build.status == 'running' %}
                                        <div class="text-muted small build-elapsed-time" data-build-id="{{ build.id }}">
                                            Elapsed: {{ '%d:%02d:%02d'|format(builds_progress[build.id].elapsed_time//3600, (builds_progress[build.id].elapsed_time//60)%60, builds_progress[build.id].elapsed_time%60) }}
                                        </div>
                                        {% if builds_progress[build.id].estimated_remaining is not none %}
                                        <div class="text-muted small build-estimated-time" data-build-id="{{ build.id }}">
                                            Est. remaining: {{ '%d:%02d:%02d'|format(builds_progress[build.id].estimated_remaining//3600, (builds_progress[build.id].estimated_remaining//60)%60, builds_progress[build.id].estimated_remaining%60) }}
                                        </div>
                                        {% endif %}
                                        {% endif %}
                                    </td>
                                    <td>{{ build.completed_at.strftime('%Y-%m-%d %H:%M:%S') if build.completed_at else 'N/A' }}</td>
                                    <td>{{ build.triggered_by }}</td>
                                    <td>
                                        <a href="{{ url_for('build_detail', build_id=build.id) }}" class="btn btn-sm btn-info">
                                            View Details
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if total_pages > 1 %}
                    <div class="d-flex justify-content-center mt-4">
                        <nav aria-label="Build pagination">
                            <ul class="pagination">
                                {% if current_page > 1 %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('dashboard', page=current_page-1) }}" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                {% endif %}

                                {% for page_num in range(max(1, current_page - 2), min(total_pages + 1, current_page + 3)) %}
                                <li class="page-item {% if page_num == current_page %}active{% endif %}">
                                    <a class="page-link" href="{{ url_for('dashboard', page=page_num) }}">{{ page_num }}</a>
                                </li>
                                {% endfor %}

                                {% if current_page < total_pages %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('dashboard', page=current_page+1) }}" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}

                    {% else %}
                    <div class="alert alert-info">
                        No builds yet. Trigger a build to get started.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Trigger Build Modal -->
<div class="modal fade" id="triggerBuildModal" tabindex="-1" aria-labelledby="triggerBuildModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="triggerBuildModalLabel">Trigger New Build</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('trigger_build') }}" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="config_id" class="form-label">Configuration</label>
                        <select class="form-select" id="config_id" name="config_id" required>
                            {% for config in configs %}
                            <option value="{{ config.id }}">{{ config.name }} ({{ config.project_path }})</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            Select the configuration to use for this build. You can manage configurations in the <a href="{{ url_for('config') }}">Configuration</a> page.
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="branch" class="form-label">Branch</label>
                        <input type="text" class="form-control" id="branch" name="branch" value="main" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Trigger Build</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    console.log('Dashboard JavaScript loaded');
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM content loaded in dashboard');
        var container = document.querySelector('.container-fluid');
        var buildInProgressAttr = container.getAttribute('data-build-in-progress');
        console.log("data-build-in-progress attribute:", buildInProgressAttr);
        var buildInProgress = buildInProgressAttr === 'true';
        console.log("buildInProgress variable:", buildInProgress);

        // Check if there are any running builds in the DOM
        var runningBuilds = document.querySelectorAll('.build-status-running');
        console.log("Running builds in DOM:", runningBuilds.length);

        // If there are running builds but buildInProgress is false, set it to true
        if (runningBuilds.length > 0 && !buildInProgress) {
            console.log("Found running builds but buildInProgress is false, setting to true");
            buildInProgress = true;
        }

        // Set progress bar widths
        var progressBars = document.querySelectorAll('.progress-bar');
        progressBars.forEach(function(bar) {
            var progress = bar.getAttribute('data-progress');
            bar.style.width = progress + '%';
        });

        // Find the highest build ID currently in the table
        var latestBuildId = 0;
        var buildRows = document.querySelectorAll('tr[data-build-id]');
        buildRows.forEach(function(row) {
            var buildId = parseInt(row.getAttribute('data-build-id'));
            if (buildId > latestBuildId) {
                latestBuildId = buildId;
            }
        });
        console.log('Initial latest build ID from DOM:', latestBuildId);

        // Connect to WebSocket server
        const socket = io();

        // Listen for build status updates
        socket.on('build_status_update', function(data) {
            console.log('Received build status update:', data);

            // If we have a new build and it was triggered by a webhook, refresh the page
            if (data.build_id > latestBuildId && data.triggered_by === 'webhook') {
                console.log('New build detected via WebSocket! Refreshing page...');
                window.location.reload();
            }
            // If the status of an existing build in the table has changed, update it
            else {
                updateBuildInTable(data);
                // Update latestBuildId if this build ID is higher
                if (data.build_id > latestBuildId) {
                    latestBuildId = data.build_id;
                    console.log('Updated latest build ID:', latestBuildId);
                }
            }
        });

        // Function to update a specific build in the table
        function updateBuildInTable(data) {
            // Find the row for this build
            const row = document.querySelector(`tr[data-build-id="${data.build_id}"]`);
            if (!row) {
                console.log('Build not found in table:', data.build_id);
                return;
            }

            console.log('Updating build in table:', data.build_id);

            // Update status
            const statusCell = row.querySelector('.build-status');
            if (statusCell) {
                // Remove all status classes
                statusCell.classList.forEach(cls => {
                    if (cls.startsWith('build-status-')) {
                        statusCell.classList.remove(cls);
                    }
                });
                // Add the new status class
                statusCell.classList.add('build-status-' + data.status);
                statusCell.textContent = data.status.toUpperCase();
            }

            // If the build is completed, update the completed_at cell
            if (data.status !== 'running' && data.status !== 'queued' && data.completed_at) {
                const completedCell = row.cells[5]; // Assuming completed_at is the 6th column (index 5)
                if (completedCell && completedCell.textContent.trim() === 'N/A') {
                    completedCell.textContent = new Date(data.completed_at).toLocaleString();
                }
            }
        }

        // Listen for build progress updates via WebSocket
        socket.on('build_progress_update', function(data) {
            console.log('Received build progress update via WebSocket:', data);

            // Validate the data before processing
            if (!data || !data.build_id || !data.current_step || !data.total_steps || data.current_step <= 0 || data.total_steps <= 0) {
                console.log('Invalid build progress data received:', data);
                return;
            }

            // Find the element for this build
            var element = document.querySelector('.build-elapsed-time[data-build-id="' + data.build_id + '"]');
            if (!element) {
                console.log('Build elapsed time element not found:', data.build_id);
                return;
            }

            // Update elapsed time
            if (data.elapsed_time && data.elapsed_time.formatted) {
                element.textContent = 'Elapsed: ' + data.elapsed_time.formatted;
            }

            // Update estimated remaining time if available
            var estimatedElement = document.querySelector('.build-estimated-time[data-build-id="' + data.build_id + '"]');
            if (estimatedElement && data.estimated_remaining && data.estimated_remaining.formatted) {
                estimatedElement.textContent = 'Est. remaining: ' + data.estimated_remaining.formatted;
            }

            // Update progress bar if needed
            var row = element.closest('tr');
            if (row && data.percent !== undefined && data.percent >= 0) {
                var progressBar = row.querySelector('.progress-bar');
                if (progressBar) {
                    // Update progress bar width
                    progressBar.style.width = data.percent + '%';
                    progressBar.setAttribute('aria-valuenow', data.percent);
                    progressBar.setAttribute('data-progress', data.percent);

                    // Update the percentage text if it exists
                    var percentElement = row.querySelector('small.text-muted');
                    if (percentElement) {
                        percentElement.textContent = data.percent + '% (Step ' + data.current_step + '/' + data.total_steps + ')';
                    }

                    // Update the progress bar class based on overdue status
                    if (data.steps_overdue) {
                        progressBar.classList.add('bg-warning');
                    } else {
                        progressBar.classList.remove('bg-warning');
                    }
                }
            }

            // Force recalculation of elapsed time percentage
            if (data.elapsed_time && data.elapsed_time.seconds) {
                // Find all running builds in the table
                var runningBuilds = document.querySelectorAll('.build-status-running');
                runningBuilds.forEach(function(buildStatus) {
                    var buildRow = buildStatus.closest('tr');
                    if (buildRow) {
                        var buildId = buildRow.getAttribute('data-build-id');
                        if (buildId == data.build_id) {
                            // Update progress bar with elapsed time percentage
                            var progressBar = buildRow.querySelector('.progress-bar');
                            if (progressBar) {
                                // Ensure progress bar is updated with the latest percentage
                                progressBar.style.width = data.percent + '%';
                            }
                        }
                    }
                });
            }
        });

        // No need to start polling functions as we're using WebSockets now
        console.log('Using WebSockets for real-time updates');
    });
</script>
{% endblock %}
